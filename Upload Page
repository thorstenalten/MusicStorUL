<%@ page language="C#" autoeventwireup="true" codefile="UploadPage.aspx.cs" inherits="UploadPage" %>

<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
<head runat="server">
    <title></title>
    <script src="https://rawgit.com/enyo/dropzone/master/dist/dropzone.js"></script>
    <link rel="stylesheet" href="https://rawgit.com/enyo/dropzone/master/dist/dropzone.css">
</head>
<body>
    <form id="form1" runat="server" >
        <div  >
            &nbsp;<asp:Label ID="lblSname" runat="server" Text="Song name: "></asp:Label>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;<asp:TextBox ID="txtSname" runat="server"></asp:TextBox>
            <br />
            <asp:FileUpload ID="FileUpload1" runat="server" Width="282px" />
            <asp:Button ID="Button1" runat="server" Text="Button" onclick="Button1_Click" />
            <asp:label runat="server"  ID="lblAccept"></asp:label>
        </div>
    </form>
</body>
</html>


using System;
using System.Collections.Generic;
using System.Linq;
using System.Web;
using System.Web.UI;
using System.Web.UI.WebControls;
using System.IO;
using System.Data;
using System.Data.SqlClient;
using System.Configuration;

public partial class UploadPage : System.Web.UI.Page
{
    protected void Page_Load(object sender, EventArgs e)
    {

    }

    protected void Button1_Click(object sender, EventArgs e)
    {
        int i = 0;
        String fileName = FileUpload1.FileName;
        string cmd = "Select * from SONG where SRC = /MusicFiles/" + fileName;
        SqlConnection connection = new SqlConnection(@"Data Source=(LocalDB)\v11.0;AttachDBFilename=|DataDirectory|\MusicStorDB.mdf;Integrated Security=True");
        SqlCommand selectCommand = new SqlCommand(cmd, connection);
        SqlCommand insertCommand = new SqlCommand("INSERT INTO song VALUES(@SID, @SRC, @Sname, @UID)", connection);
        SqlCommand command = new SqlCommand("SELECT MAX(SID) as MAX FROM SONG", connection);

        try
        {
            int sid = 0;
            bool existsAlready = false;
            connection.Open();
            SqlDataReader reader = command.ExecuteReader();
            if (reader.HasRows)
                 sid = reader.GetInt32(reader.GetOrdinal("MAX"));
            reader.Close();
            sid++;
            reader = selectCommand.ExecuteReader();
            if (reader.HasRows)
            {
                existsAlready = true;
            }
            reader.Close();

            //If there exists a song with the same name it will put your UID at the end to differenciate
            if (existsAlready && !sameSize("/MusicFiles/" + fileName ))
            {
                //fileName = Path.GetFileNameWithoutExtension(fileName) + "-" + Request.Cookies["loginInfo"]["username"] + Path.GetExtension(fileName);
            }

            insertCommand.Parameters.Add("@SID", SqlDbType.VarChar).Value = sid;
            insertCommand.Parameters.Add("@SRC", SqlDbType.VarChar).Value = fileName;

            if(!String.IsNullOrWhiteSpace(txtSname.Text))
                insertCommand.Parameters.Add("@Sname", SqlDbType.VarChar).Value = sid;
            else
                insertCommand.Parameters.Add("@Sname", SqlDbType.VarChar).Value = DBNull.Value;

            insertCommand.Parameters.Add("@UID", SqlDbType.VarChar).Value = 13136224; // =Request.Cookies["loginInfo"]["username"] 





            if (FileUpload1.HasFile && checkIsMusic(System.IO.Path.GetExtension(FileUpload1.FileName)))
            {
                FileUpload1.SaveAs(Server.MapPath("/MusicFiles/" + FileUpload1.FileName));
                lblAccept.Text = "File uploaded!";
            }
            else
                lblAccept.Text = "Incorrect File Type!!";

            connection.Close();
        }
        catch (SqlException sqlEx)
        {
            Response.Write("</br>Error writing to database: " + sqlEx);
        }
    }

    public bool checkIsMusic(string file)
    {
        string extension = Path.GetExtension(file);
        extension = extension.ToLower();
        switch (extension)
        {
            case ".mp3":
                return true;
            case ".wav":
                return true;
            case ".ogg":
                return true;
            default:
                return false;
        }

    }
    public bool sameSize(string s)
    {
        FileInfo f = new FileInfo(s);
        long x = f.Length;
        long up = FileUpload1.PostedFile.ContentLength;
        if (x == up)
        {
            return true;
        }
        else
            return false;
    }
}
